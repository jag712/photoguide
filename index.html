<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>쮸쀼의 비밀교실 (✨)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jamo-js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            color: #4A4A4A;
        }
        .nav-item {
            transition: all 0.2s ease-in-out;
        }
        .nav-item.active {
            background-color: #4A5568;
            color: #FFFFFF;
            transform: translateX(4px);
        }
        .nav-item:not(.active):hover {
            background-color: #E2E8F0;
            color: #2D3748;
        }
        .content-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.3s ease;
        }
        .content-card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .question {
            cursor: pointer;
        }
        .answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.7s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1.5rem;
        }
        .answer.open {
            max-height: 5000px; /* 충분한 높이 확보 */
            padding: 1.5rem;
        }
        .fa-chevron-down {
            transition: transform 0.3s ease-in-out;
        }
        .question.open .fa-chevron-down {
            transform: rotate(180deg);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 40vh;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F1F1F1; }
        ::-webkit-scrollbar-thumb { background: #A0AEC0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .stop-btn {
            transition: background-color 0.2s ease-in-out;
        }
        .stop-btn.active {
            background-color: #4A5568;
            color: white;
        }
        .ai-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
            background-color: #f3f4f6;
            color: #4b5563;
            transition: background-color 0.2s;
            border: 1px solid #e5e7eb;
            cursor: pointer;
        }
        .ai-btn:hover {
            background-color: #e5e7eb;
        }
        .ai-btn i {
            margin-right: 0.375rem;
        }
        .prose {
            color: #374151;
            line-height: 1.65;
        }
        .prose strong { font-weight: 600; }
        .prose p { margin-bottom: 1em; }
        .quiz-option {
            border: 2px solid #E2E8F0;
            transition: all 0.2s ease;
        }
        .quiz-option:hover {
            border-color: #4A5568;
            background-color: #f7fafc;
        }
        .quiz-option.selected {
            border-color: #4A5568;
            background-color: #E2E8F0;
        }
        .quiz-option.correct {
            background-color: #C6F6D5;
            border-color: #38A169;
        }
        .quiz-option.incorrect {
            background-color: #FED7D7;
            border-color: #E53E3E;
        }
    </style>
</head>
<body class="antialiased bg-gray-50">
    <div class="flex flex-col md:flex-row min-h-screen">
        <nav class="w-full md:w-64 bg-white p-4 md:p-6 shadow-lg md:shadow-none shrink-0 z-10">
            <a href="#" id="homeLink" data-category="home" class="flex items-center mb-6 cursor-pointer">
                <i class="fas fa-camera-retro text-3xl text-gray-700 mr-3"></i>
                <h1 class="text-xl font-bold text-gray-800">쮸쀼의 비밀교실✨</h1>
            </a>
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="용어 검색..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400">
            </div>
            <ul>
                <li><a href="#" class="nav-item block py-3 px-4 mb-2 rounded-lg font-semibold text-gray-700 active" data-category="home">일정</a></li>
                <li><a href="#" class="nav-item block py-3 px-4 mb-2 rounded-lg font-semibold text-gray-700" data-category="visualization">시각화</a></li>
                <li><a href="#" class="nav-item block py-3 px-4 mb-2 rounded-lg font-semibold text-gray-700" data-category="structure">카메라 구조와 원리</a></li>
                <li><a href="#" class="nav-item block py-3 px-4 mb-2 rounded-lg font-semibold text-gray-700" data-category="exposure">노출</a></li>
                <li><a href="#" class="nav-item block py-3 px-4 mb-2 rounded-lg font-semibold text-gray-700" data-category="lens">렌즈와 광학</a></li>
                <li><a href="#" class="nav-item block py-3 px-4 mb-2 rounded-lg font-semibold text-gray-700" data-category="digital">디지털</a></li>
                <li><a href="#" class="nav-item block py-3 px-4 mb-2 rounded-lg font-semibold text-gray-700" data-category="film">필름과 현상</a></li>
                <li><a href="#" class="nav-item block py-3 px-4 mb-2 rounded-lg font-semibold text-gray-700" data-category="lighting">조명과 필터</a></li>
                <li><a href="#" class="nav-item block py-3 px-4 mb-2 rounded-lg font-semibold text-gray-700" data-category="history">사진사 & 사조</a></li>
            </ul>
            <div class="mt-6">
                <button id="quizBtn" class="w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 transition-colors"><i class="fas fa-magic mr-2"></i> AI 퀴즈 생성</button>
            </div>
        </nav>

        <main id="mainContent" class="flex-1 p-4 md:p-10 overflow-y-auto">
        </main>
    </div>

    <!-- Gemini AI Modal -->
    <div id="geminiModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col transform transition-all duration-300 scale-95">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-robot text-blue-500 mr-3"></i>AI 어시스턴트</h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl font-light">&times;</button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto">
                 <div id="loadingSpinner" class="hidden flex justify-center items-center h-48">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-gray-900"></div>
                </div>
                <div id="modalResponse" class="prose max-w-none"></div>
            </div>
        </div>
    </div>
    
    <script src="data.js"></script>
    <script>
    // --- 전역 변수 ---
    const mainContent = document.getElementById('mainContent');
    const navLinks = document.querySelectorAll('.nav-item');
    const searchInput = document.getElementById('searchInput');
    const homeLink = document.getElementById('homeLink');
    const quizBtn = document.getElementById('quizBtn');

    // Modal elements
    const geminiModal = document.getElementById('geminiModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalResponse = document.getElementById('modalResponse');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const closeModalBtn = document.getElementById('closeModalBtn');
    
    let charts = {};
    let currentQuizData = null;
    let currentQuestionIndex = 0;
    let score = 0;

    // --- Gemini API 호출 함수 (퀴즈 JSON 스키마 지원 포함) ---
    async function callGeminiAPI(prompt, useSchema = false) {
        showModal();
        modalResponse.innerHTML = '';
        loadingSpinner.classList.remove('hidden');

        const apiKey = ""; // API key should be left blank
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {}
        };

        if (useSchema) {
            payload.generationConfig.responseMimeType = "application/json";
            payload.generationConfig.responseSchema = {
                type: "OBJECT",
                properties: {
                    questions: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                question: { type: "STRING" },
                                options: { type: "ARRAY", items: { type: "STRING" } },
                                answer: { type: "STRING" }
                            },
                            required: ["question", "options", "answer"]
                        }
                    }
                }
            };
        }

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API request failed: ${response.status}`);

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!text) throw new Error("No content received from API.");
            
            return text;
        } catch (error) {
            console.error("Gemini API Error:", error);
            modalResponse.innerHTML = `<p class="text-red-500">AI 기능을 호출하는 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.</p>`;
            return null;
        } finally {
            loadingSpinner.classList.add('hidden');
        }
    }

    // --- 모달 제어 함수 ---
    function showModal() {
        geminiModal.classList.remove('hidden');
        setTimeout(() => geminiModal.querySelector('div > div').classList.remove('scale-95'), 10);
    }

    function hideModal() {
        geminiModal.querySelector('div > div').classList.add('scale-95');
        setTimeout(() => geminiModal.classList.add('hidden'), 300);
    }
    
    // --- 퀴즈 관련 함수 ---
    function displayQuizQuestion() {
        const q = currentQuizData.questions[currentQuestionIndex];
        const optionsHtml = q.options.map(option => `
            <div class="quiz-option p-4 rounded-lg cursor-pointer mb-2" data-option="${option.replace(/"/g, '&quot;')}">${option}</div>
        `).join('');
        modalResponse.innerHTML = `
            <div class="mb-4">
                <p class="text-sm text-gray-500">문제 ${currentQuestionIndex + 1} / ${currentQuizData.questions.length}</p>
                <p class="text-lg font-semibold mt-1">${q.question}</p>
            </div>
            <div id="quizOptions">${optionsHtml}</div>
            <div id="quizResult" class="mt-4 font-semibold"></div>
            <div class="flex justify-end mt-4">
                <button id="nextQuestionBtn" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-800 hidden">다음 문제</button>
            </div>
        `;
       
        modalResponse.querySelectorAll('.quiz-option').forEach(option => {
            option.addEventListener('click', (e) => {
                modalResponse.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
                e.currentTarget.classList.add('selected');
                checkQuizAnswer();
            });
        });
       
        modalResponse.querySelector('#nextQuestionBtn').addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuizData.questions.length) {
                displayQuizQuestion();
            } else {
                displayQuizFinalScore();
            }
        });
    }

    function checkQuizAnswer() {
        const selectedOptionEl = modalResponse.querySelector('.quiz-option.selected');
        if (!selectedOptionEl) return;
       
        const selectedAnswer = selectedOptionEl.dataset.option;
        const correctAnswer = currentQuizData.questions[currentQuestionIndex].answer;

        modalResponse.querySelectorAll('.quiz-option').forEach(opt => {
            opt.style.pointerEvents = 'none'; 
            const optionText = opt.dataset.option;
            if (optionText === correctAnswer) {
                opt.classList.add('correct');
            } else if (opt.classList.contains('selected')) {
                opt.classList.add('incorrect');
            }
        });

        if (selectedAnswer === correctAnswer) {
            score++;
            modalResponse.querySelector('#quizResult').innerHTML = `<p class="text-green-600">정답입니다!</p>`;
        } else {
            modalResponse.querySelector('#quizResult').innerHTML = `<p class="text-red-600">오답입니다. 정답은 "${correctAnswer}" 입니다.</p>`;
        }
       
        modalResponse.querySelector('#nextQuestionBtn').classList.remove('hidden');
    }

    function displayQuizFinalScore() {
        modalResponse.innerHTML = `
            <div class="text-center">
                <h2 class="text-2xl font-bold mb-4">퀴즈 완료!</h2>
                <p class="text-lg">총 ${currentQuizData.questions.length}문제 중 <span class="font-bold text-xl text-gray-800">${score}</span>문제를 맞혔습니다.</p>
                <button id="restartQuizBtn" class="mt-6 bg-gray-700 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-800">다시 풀기</button>
            </div>
        `;
        modalResponse.querySelector('#restartQuizBtn').addEventListener('click', generateQuiz);
    }

    async function generateQuiz() {
        const activeLink = document.querySelector('.nav-item.active');
        const category = activeLink ? activeLink.dataset.category : 'all';
        const categoryName = activeLink ? activeLink.textContent : '전체';
       
        modalTitle.innerHTML = `<i class="fas fa-magic text-yellow-500 mr-3"></i> ${categoryName} 퀴즈`;
       
        let contentForQuiz = [];
        if (['home', 'visualization', 'all'].includes(category) || !photographyData[category]) {
            Object.values(photographyData).forEach(cat => contentForQuiz.push(...cat));
        } else {
            contentForQuiz = photographyData[category];
        }
       
        const shuffledTerms = contentForQuiz.sort(() => 0.5 - Math.random());
        const topics = shuffledTerms.slice(0, 15).map(item => item.q).join(', ');

        const prompt = `다음 사진학 주제들을 바탕으로 객관식 퀴즈 5개를 생성해줘: ${topics}. 각 질문은 4개의 선택지를 가져야 하고, 그 중 하나만 정답이어야 해. 질문의 난이도는 '아주 쉬운 문제 1개', '보통 문제 2개', '어려운 문제 2개'로 구성해줘. 질문, 선택지, 정답을 JSON 형식으로 반환해줘.`;
       
        const responseText = await callGeminiAPI(prompt, true);
        if (!responseText) return;
       
        try {
            let parsedData = JSON.parse(responseText);
            if (parsedData && Array.isArray(parsedData.questions) && parsedData.questions.length > 0) {
                currentQuizData = parsedData;
                currentQuestionIndex = 0;
                score = 0;
                displayQuizQuestion();
            } else {
                throw new Error("Invalid quiz format received.");
            }
        } catch(e) {
            console.error("Quiz parsing error:", e);
            modalResponse.innerHTML = `<p class="text-red-500">퀴즈를 생성하는 데 실패했습니다. AI가 유효한 퀴즈 형식을 반환하지 못했습니다. 잠시 후 다시 시도해주세요.</p>`;
        }
    }

    // --- AI 설명 관련 함수 ---
    async function handleExplanation(e) {
        const button = e.target.closest('.ai-btn');
        if (!button) return;

        const action = button.dataset.action;
        const term = button.dataset.term;
        const description = button.dataset.desc;
        let prompt = '';

        if (action === 'explain') {
            modalTitle.innerHTML = `<i class="fas fa-brain text-purple-500 mr-3"></i>"${term}" 쉽게 이해하기`;
            prompt = `사진학 용어인 "${term}"에 대해 핵심만 짚어 입시생이 시험장에서 바로 활용할 수 있도록 간결하게 설명해줘. 현재 설명: ${description}`;
        } else if (action === 'deepen') {
            modalTitle.innerHTML = `<i class="fas fa-search-plus text-indigo-500 mr-3"></i>"${term}" 깊이 알아보기`;
            prompt = `사진학 개념인 "${term}"에 대해 더 깊이 알고 싶어. 다음 기본 설명을 바탕으로, 관련된 심화 개념, 역사적 배경, 또는 실전 촬영 팁을 포함하여 전문가 수준의 추가 정보를 제공해줘. 현재 설명: ${description}`;
        }
       
        if(prompt) {
            const responseText = await callGeminiAPI(prompt, false);
            if(responseText) modalResponse.innerHTML = `<p>${responseText.replace(/\n/g, '<br>')}</p>`;
        }
    }

    // --- 렌더링 및 UI 함수 ---
    function createCalendar(year, month, events = {}) {
        const monthNames = ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"];
        const days = ['일', '월', '화', '수', '목', '금', '토'];
        const date = new Date(year, month - 1, 1);
        const firstDay = date.getDay();
        const daysInMonth = new Date(year, month, 0).getDate();
        let html = `<div class="content-card p-6 w-full max-w-4xl mx-auto mb-8"><h3 class="text-xl font-bold text-center mb-4">${year}년 ${monthNames[month-1]}</h3><div class="grid grid-cols-7 gap-1 text-center text-sm font-semibold text-gray-600">${days.map(day => `<div class="${day === '일' ? 'text-red-500' : (day === '토' ? 'text-blue-500' : '')}">${day}</div>`).join('')}</div><div class="grid grid-cols-7 gap-1 mt-2">`;
        for (let i = 0; i < firstDay; i++) { html += `<div></div>`; }
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDayOfWeek = new Date(year, month - 1, day).getDay();
            const dayEvents = events[day] || [];
            let eventHtml = dayEvents.map(e => `<div class="text-white text-[10px] p-1 rounded-md ${e.color || 'bg-blue-500'} mb-1 truncate" title="${e.title}">${e.title}</div>`).join('');
            let dayClass = '';
            if (currentDayOfWeek === 0 || dayEvents.some(e => e.isHoliday)) dayClass = 'text-red-500';
            else if (currentDayOfWeek === 6) dayClass = 'text-blue-500';
            html += `<div class="border p-2 h-28 flex flex-col ${dayEvents.length > 0 ? 'bg-gray-50' : ''}"><span class="font-bold ${dayClass}">${day}</span><div class="mt-1 overflow-y-auto">${eventHtml}</div></div>`;
        }
        html += `</div></div>`;
        return html;
    }

    function createChart(canvasId, label, data, backgroundColor, borderColor) {
        const ctx = document.getElementById(canvasId)?.getContext('2d');
        if (!ctx) return;
        if (charts[canvasId]) { charts[canvasId].destroy(); }
        charts[canvasId] = new Chart(ctx, { type: 'bar', data: { labels: data.map(item => item.label), datasets: [{ label: label, data: data.map(item => item.value), backgroundColor: backgroundColor, borderColor: borderColor, borderWidth: 1 }] }, options: { maintainAspectRatio: false, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 10 }, autoSkip: true, maxTicksLimit: 15 } } }, plugins: { legend: { display: false }, tooltip: { displayColors: false, callbacks: { label: (context) => data[context.dataIndex].desc || '' } } } } });
    }

    function renderContent(category, searchTerm = '') {
        let html = '';
        if (category === 'home') {
            const eventsForSept = {};
            (calendarEvents[9] || []).forEach(e => { (eventsForSept[e.day] = eventsForSept[e.day] || []).push({ ...e }); });
            const eventsForOct = {};
            (calendarEvents[10] || []).forEach(e => { (eventsForOct[e.day] = eventsForOct[e.day] || []).push({ ...e }); });
            html = `<div class="content-card p-6 md:p-8 mb-6 text-center"><h2 class="text-3xl font-bold text-gray-800 mb-2">주요 학사 일정 ✨</h2><p class="text-gray-600">중요한 입시 일정을 확인하세요.</p></div>${createCalendar(2025, 9, eventsForSept)}${createCalendar(2025, 10, eventsForOct)}`;
        } else if (category === 'visualization') {
            html = `
            <div class="content-card p-6 md:p-8 mb-6"><h2 class="text-3xl font-bold text-gray-800 mb-2">중요 개념 시각화</h2><p class="text-lg text-gray-600">복잡한 개념들을 도표로 쉽게 이해해보세요.</p></div>
            <div class="content-card mb-4">
                <div class="question p-6 flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">노출의 이해: 조리개와 셔터 속도</h3><i class="fas fa-chevron-down"></i></div>
                <div class="answer"><div class="p-6 border-t"><div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <div class="flex justify-center items-center mb-4"><h3 class="text-xl font-bold text-center mr-4">조리개</h3><div class="flex rounded-lg bg-gray-200 p-1 text-sm"><button class="stop-btn active px-3 py-1 rounded-md" data-chart="aperture" data-stop="fullStop">1 스톱</button><button class="stop-btn px-3 py-1 rounded-md" data-chart="aperture" data-stop="thirdStop">1/3 스톱</button></div></div>
                        <div class="chart-container"><canvas id="apertureChart"></canvas></div>
                    </div>
                    <div>
                        <div class="flex justify-center items-center mb-4"><h3 class="text-xl font-bold text-center mr-4">셔터 속도</h3><div class="flex rounded-lg bg-gray-200 p-1 text-sm"><button class="stop-btn active px-3 py-1 rounded-md" data-chart="shutter" data-stop="fullStop">1 스톱</button><button class="stop-btn px-3 py-1 rounded-md" data-chart="shutter" data-stop="thirdStop">1/3 스톱</button></div></div>
                        <div class="chart-container"><canvas id="shutterChart"></canvas></div>
                    </div>
                </div></div></div>
            </div>`;
        } else {
            let itemsToRender = [];
            const categoryTitle = document.querySelector(`.nav-item[data-category="${category}"]`)?.textContent || "검색 결과";
            html = `<div class="content-card p-6 md:p-8 mb-6 text-center"><h2 class="text-3xl font-bold text-gray-800 mb-2">${categoryTitle}</h2></div>`;
            
            if (searchTerm) {
                const jamoSearch = Jamo.jamo(searchTerm.toLowerCase());
                const allData = Object.values(photographyData).flat();
                itemsToRender = allData.filter(item =>
                    item && item.q && item.a && (
                        item.q.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.a.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        Jamo.jamo(item.q.toLowerCase()).includes(jamoSearch)
                    )
                );
            } else {
                itemsToRender = photographyData[category] || [];
            }
            
            if (itemsToRender.length > 0) {
                html += itemsToRender.map(item => `
                <div class="content-card mb-4">
                    <div class="question p-6 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-800">${item.q}</h3>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="answer">
                        <div class="p-6 border-t">
                            <p class="text-gray-700 leading-relaxed">${item.a.replace(/\n/g, '<br>')}</p>
                            <div class="mt-4 pt-4 border-t border-gray-200 border-dashed flex flex-wrap gap-2">
                                <button class="ai-btn" data-action="explain" data-term="${item.q.replace(/"/g, '&quot;')}" data-desc="${item.a.replace(/"/g, '&quot;')}"><i class="fas fa-brain"></i>쉽게 설명</button>
                                <button class="ai-btn" data-action="deepen" data-term="${item.q.replace(/"/g, '&quot;')}" data-desc="${item.a.replace(/"/g, '&quot;')}"><i class="fas fa-search-plus"></i>깊이 알아보기</button>
                            </div>
                        </div>
                    </div>
                </div>`).join('');
            } else {
                html += `<div class="content-card p-8 text-center"><p>관련 내용을 찾을 수 없습니다.</p></div>`;
            }
        }
        
        mainContent.innerHTML = html;
        
        mainContent.querySelectorAll('.question').forEach(q => q.addEventListener('click', (e) => {
            const questionDiv = e.currentTarget;
            const answer = questionDiv.nextElementSibling;
            
            // Close other open answers
            if (!answer.classList.contains('open')) {
                document.querySelectorAll('.answer.open').forEach(openAnswer => {
                    openAnswer.classList.remove('open');
                    openAnswer.previousElementSibling.classList.remove('open');
                });
            }

            questionDiv.classList.toggle('open');
            answer.classList.toggle('open');
        }));

        if (category === 'visualization') {
            setTimeout(() => {
                const updateChart = (chartName, stopType) => { const data = visualizationData[chartName][stopType]; const color = chartName === 'aperture' ? ['rgba(75, 192, 192, 0.6)', 'rgba(75, 192, 192, 1)'] : ['rgba(255, 159, 64, 0.6)', 'rgba(255, 159, 64, 1)']; createChart(`${chartName}Chart`, chartName, data, color[0], color[1]); };
                updateChart('aperture', 'fullStop');
                updateChart('shutter', 'fullStop');
                document.querySelectorAll('.stop-btn').forEach(button => button.addEventListener('click', (e) => { const chart = e.target.dataset.chart; const stop = e.target.dataset.stop; document.querySelectorAll(`[data-chart="${chart}"]`).forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); updateChart(chart, stop); }));
            }, 0);
        }
    }

    // --- 이벤트 리스너 ---
    function handleNavClick(e) {
        e.preventDefault();
        const targetLink = e.target.closest('a');
        if (!targetLink) return;
        const category = targetLink.dataset.category;
        searchInput.value = '';
        document.querySelectorAll('nav a').forEach(link => link.classList.remove('active'));
        targetLink.classList.add('active');
        renderContent(category);
    }

    document.querySelectorAll('nav a').forEach(link => link.addEventListener('click', handleNavClick));
    
    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value;
        if (searchTerm.length > 0) {
            document.querySelectorAll('nav a').forEach(link => link.classList.remove('active'));
            renderContent(null, searchTerm);
        } else {
            homeLink.click();
        }
    });

    quizBtn.addEventListener('click', generateQuiz);
    mainContent.addEventListener('click', handleExplanation);
    closeModalBtn.addEventListener('click', hideModal);
    geminiModal.addEventListener('click', (e) => { if (e.target === geminiModal) hideModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === "Escape") hideModal(); });

    // --- 초기화 ---
    renderContent('home');

    </script>
</body>
</html>

